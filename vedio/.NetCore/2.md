# Consul
  
    核心思想为将集群服务注册到consul由Consul进行统一管理,提供统一入口由consul代理访问,并可以在代理访问时进行合理的负载均衡策略。

### 一、Consul 服务发现
  
###### 1.在服务中注册Consul服务
      
      在.net中需要载neget下载Consul对应的SDK
      
  ```.cs
public static void ConsulRegist(this IConfiguration configuration)
{
   ConsulClient client = new ConsulClient(c =>
   {
       c.Address = new Uri("http://localhost:8500/");
       c.Datacenter = "dc1";
   });
   string ip = configuration["ip"];
   int port = int.Parse(configuration["port"]);//命令行参数必须传入
   int weight = string.IsNullOrWhiteSpace(configuration["weight"]) ? 1 : int.Parse(configuration["weight"]);//命令行参数必须传入
   client.Agent.ServiceRegister(new AgentServiceRegistration()
   {
       //Guid.NewGuid(),//唯一的
       ID = "service" + ip+":" + port ,
       //组名称-Group
       Name = "ServiceTest",
       //ip地址
       Address = ip,
       //不同服务实例
       Port = port,
       //标签 用作负载策略
       Tags = new string[] { weight.ToString() },
       //配置心跳检查
       Check = new AgentServiceCheck()
       {
           //服务健康检查轮询时间
           Interval = TimeSpan.FromSeconds(12),
           //心跳服务地址
           HTTP = $"http://{ip}:{port}/Api/Health/Index",
           //超时时间
           Timeout = TimeSpan.FromSeconds(5),
           //服务挂掉之后5秒注销服务
           DeregisterCriticalServiceAfter = TimeSpan.FromSeconds(5)
       }
   }); ;
    Console.WriteLine($"http://{ip}:{port}完成注册");
}
  ```
  ###### 2.启动consul服务
  
  ```.bat
  @echo off
  color 02
  consul_1.6.2.exe agent -dev
  pause
  ```
  ###### 3.启动api服务
  ```.bat
  @echo off
  color 02
  dotnet WebApplication.Core.WebApi.dll --urls="http://*:5177" --ip="127.0.0.1" --port=5177 --weight=3
  pause
  ```
  
 ### 二、Consul （负载均衡策略）服务调用 
  
  `获取注册的服务集合array`
  ```.cs
  Uri uri = new Uri("http://ServiceTest/api/users/get");
  string groupName = uri.Host;
  using (ConsulClient client = new ConsulClient(c =>
  {
      c.Address = new Uri("http://localhost:8500/");
      c.Datacenter = "dc1";
  }))
  
  var dictionary = client.Agent.Services().Result.Response;
  var list = dictionary.Where(k => k.Value.Service.Equals(groupName, StringComparison.OrdinalIgnoreCase)) ;
  KeyValuePair<string, AgentService> keyValuePair = new KeyValuePair<string, AgentService>();
  keyValuePair = list.First();//直接拿的第一个
  //服务集合
  var array = list.ToArray();
  }
  ```
  
###### 1.随机平均策略访问
  ```.cs
 private static int iSeed = 0;
  //随机策略---平均策略
 keyValuePair = array[new Random(iSeed++).Next(0, array.Length)];

  ```
###### 2.轮询平均策略访问
  ```.cs
 private static int iSeed = 0;
  //随机策略---平均策略
 keyValuePair = array[iSeed++ % array.Length];

  ```
###### 3.权重策略访问
    在注册服务时，设置权重，在分配时获取权重并以此为依据
  ```.cs
  List<KeyValuePair<string, AgentService>> pairsList = new List<KeyValuePair<string, AgentService>>();
  foreach (var pair in list)
  {
      //得到每一个服务实例设置的权重，然后加入到集合
      int count = int.Parse(pair.Value.Tags?[0]);
      for (int i = 0; i < count; i++)
      {
          pairsList.Add(pair);
      }
  }
  keyValuePair = pairsList.ToArray()[new Random(iSeed++).Next(0, pairsList.Count())];
  tring resultUrl = $"{uri.Scheme}://{keyValuePair.Value.Address}:{keyValuePair.Value.Port}{uri.PathAndQuery}";
  ```
 
  
